/**********************************************************************************************************************
 * \file Tft_lvgl_init.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "Tft_lvgl_init.h"

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototype-------------------------------------------------*/
/*********************************************************************************************************************/
static void my_flush_cb(lv_disp_drv_t * disp_drv, const lv_area_t * area, lv_color_t * color_p);
static void my_touchpad_read_cb(lv_indev_drv_t * indev_drv, lv_indev_data_t * data);

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementation-----------------------------------------------*/
/*********************************************************************************************************************/
/* Function to configure LVGL
 * Additional information can be found on the LVGL web page */
void tft_lvgl_configure(void)
{
    tft_init();
    lv_init();

    /* Create a display buffer for LVGL */
    static lv_disp_draw_buf_t disp_buf;
    static lv_color_t buf_1[TFT_XSIZE * 32];
    lv_disp_draw_buf_init(&disp_buf, buf_1, NULL, TFT_XSIZE * 32);

    /* A variable to hold the drivers */
    static lv_disp_drv_t disp_drv;
    /* Basic initialization */
    lv_disp_drv_init(&disp_drv);
    /* Set your driver function. Set a flush callback to draw to the display */
    disp_drv.flush_cb = my_flush_cb;
    /* Assigns the buffer to the display. Set an initialized buffer */
    disp_drv.draw_buf = &disp_buf;
    disp_drv.full_refresh = 1;

    /* Set the resolution of the display */
    disp_drv.hor_res = TFT_XSIZE;
    disp_drv.ver_res = TFT_YSIZE;

    lv_disp_t * disp;
    /* Finally register the driver */
    disp = lv_disp_drv_register(&disp_drv);

    touch_init();
    static lv_indev_drv_t indev_drv;
    /* Basic initialization */
    lv_indev_drv_init(&indev_drv);
    indev_drv.type = LV_INDEV_TYPE_POINTER;
    indev_drv.read_cb = my_touchpad_read_cb;

    /* Register the driver in LVGL and save the created input device object */
    lv_indev_t * indev_touchpad;
    indev_touchpad = lv_indev_drv_register(&indev_drv);
}

/* Callback to copy a buffer's content to a specific area of the display
 * Additional information can be found on the LVGL web page */
static void my_flush_cb(lv_disp_drv_t * disp_drv, const lv_area_t * area, lv_color_t * color_p)
{
    /* The most simple case (but also the slowest) to put all pixels to the screen one by one */
    uint32 numberOfPixel;
    if ((area->x2 >= area->x1) && area->y2 >= area->y1)
    {
      numberOfPixel = ((area->x2+1) - area->x1) * ((area->y2+1) - area->y1);
      tft_display_setxy((uint32)area->x1, (uint32)area->y1, (uint32)area->x2, (uint32)area->y2);
        tft_flush_row_buff(numberOfPixel, color_p);

    /* Inform the graphics library that you are ready with the flushing */
    lv_disp_flush_ready(disp_drv);
    }
}

/* Callback to read coordinates of touch event
*  Additional information can be found on the LVGL web page */
static void my_touchpad_read_cb(lv_indev_drv_t * indev_drv, lv_indev_data_t * data)
{
    /* Save the pressed coordinates and the state */
    if ((touch_driver.touchmode & MASK_TOUCH_DOWN) != 0 || (touch_driver.touchmode & MASK_TOUCH_MOVE) != 0)
    {
        touch_driver.touchmode &= ~MASK_TOUCH_DOWN;
        touch_driver.touchmode &= ~MASK_TOUCH_MOVE;
        data->point.x = touch_driver.xdisp;
        data->point.y = touch_driver.ydisp;
        data->state = LV_INDEV_STATE_PRESSED;
    }
    else
    {
       data->state = LV_INDEV_STATE_RELEASED;
    }
}
