/**********************************************************************************************************************
 * \file JSON_Processing.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "Ifx_Types.h"
#include "JSON_Processing.h"

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
char g_JSONDocument[] =                                                 /* JSON Test Document                        */
        "{\n"
            "   \"firstName\": \"Stephanie\",\n\r"
            "    \"lastName\": \"Henderson\",\n\r"
            "    \"age\": 32,\n\r"
            "    \"address\": {\n\r"
                "        \"streetAddress\": \"478-9922 Posuere Ave\",\n\r"
                "        \"city\": \"Hatay\",\n\r"
                "        \"state\": \"Costa Rica\",\n\r"
                "        \"postalCode\": \"123293\"\n\r"
            "    },\n\r"
            "    \"phoneList\": [\n\r"
                "        {\n\r"
                    "            \"type\": \"personal\",\n\r"
                    "            \"number\": \"09832209761\"\n\r"
                "        },\n\r"
                "        {\n\r"
                    "            \"type\": \"fax\",\n\r"
                    "            \"number\": \"91-342-2567692\"\n\r"
                "        }\n\r"
            "    ]\n\r"
        "}\n\r";

json_t g_JSONProperties[JSON_PROPERTIES_COUNT];                        /* Storage for the JSON properties     */

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/
IFX_INLINE void Print_Label(char * name);
void Print_Field(char * name, const char * value);

void Process_JSON (void)
{
    /* Inform the user and parse the JSON document */
    printf("Parsing JSON document.\n\r");
    printf(g_JSONDocument);

    /* Parsing JSON document using the tiny-json library */
    json_t const *json = json_create(g_JSONDocument, g_JSONProperties, JSON_PROPERTIES_COUNT);

    if (!json)
    {
        printf("Unable to parse JSON document.\n");
        return;
    }

    printf("\n\r");

    /* Search for a property, validate it, and get its value afterwards */
    json_t const *firstName = json_getProperty(json, FIRST_NAME_FIELD);
    Print_Label("First Name");
    if (!firstName || JSON_TEXT != json_getType(firstName))
    {
        printf(NOT_FOUND);
    } else {
        char const *firstNameVal = json_getValue(firstName);
        printf("%s\n\r", firstNameVal);
    }

    /* Search for a property and get its value immediately */
    char const *lastName = json_getPropertyValue(json, LAST_NAME_FIELD);
    Print_Label("Last Name");
    if (!lastName)
    {
        printf(NOT_FOUND);
    } else {
        printf("%s\n\r", lastName);
    }

    json_t const *age = json_getProperty(json, AGE_FIELD);
    Print_Label("Age");
    if (!age || JSON_INTEGER != json_getType(age))
    {
        printf(NOT_FOUND);
    } else {
        int const ageVal = (int) json_getInteger(age);
        printf("%d\n\r", ageVal);
    }

    json_t const *address = json_getProperty(json, ADDRESS_FIELD);
    Print_Label("Address");
    printf("\n\r");
    if (!address || JSON_OBJ != json_getType(address))
    {
        printf(NOT_FOUND);
    } else {
        char const *street = json_getPropertyValue(address, STREET_ADDRESS_FIELD);
        Print_Field("\t  Street", street);

        char const *city = json_getPropertyValue(address, CITY_FIELD);
        Print_Field("\t  City", city);

        char const *state = json_getPropertyValue(address, STATE_FIELD);
        Print_Field("\t  State", state);

        char const *zip = json_getPropertyValue(address, POSTAL_CODE_FIELD);
        Print_Field("\t  Zip Code", zip);
    }

    json_t const *phoneList = json_getProperty(json, PHONE_LIST_FIELD);
    Print_Label("Phone List");
    printf("\n\r");
    if (!phoneList || JSON_ARRAY != json_getType(phoneList))
    {
        printf(NOT_FOUND);
    } else {
        /* Iterate through an array of objects */
        json_t const *phone;
        int i=1;
        for (phone = json_getChild(phoneList); phone != 0; phone = json_getSibling(phone))
        {
            if (JSON_OBJ == json_getType(phone))
            {
                printf("\tEntry %d\n\r", i++);
                char const *phoneType = json_getPropertyValue(phone, TYPE_FIELD);
                Print_Field("\t  Type", phoneType);

                char const *phoneNumber = json_getPropertyValue(phone, NUMBER_FIELD);
                Print_Field("\t  Number", phoneNumber);
            }
        }
    }
}

void Print_Label(char * name) {
    printf("%-12s%s", name, ": ");
}

void Print_Field(char * name, char const * value) {
    Print_Label(name);
    if (value) {
        printf("%s\n\r", value);
    }
    else {
        printf("\t" NOT_FOUND);
    }
}
