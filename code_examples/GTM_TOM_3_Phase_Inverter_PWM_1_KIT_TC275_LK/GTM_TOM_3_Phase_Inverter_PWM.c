
/**********************************************************************************************************************
 * \file GTM_TOM_3_Phase_Inverter_PWM.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "GTM_TOM_3_Phase_Inverter_PWM.h"
#include "Ifx_Types.h"
#include "IfxGtm_Tom_PwmHl.h"
#include "IfxCpu_Irq.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/
#define PWM_FREQ_HZ               20000                            /* Define the PWM Switching Frequency value in Hz */
#define PWM_DEAD_TIME             0.5e-6                           /* Define the dead time in s.                     */
#define PWM_MIN_PULSE_TIME        1.0e-6                           /* Define the minimum pulse allowed in s.         */

#define PHASE_U_HS                &IfxGtm_TOM1_2_TOUT20_P00_11_OUT /* Pin driven by the PWM, P00.11                  */
#define PHASE_U_LS                &IfxGtm_TOM1_1_TOUT19_P00_10_OUT /* Pin driven by the PWM, P00.10                  */
#define PHASE_V_HS                &IfxGtm_TOM1_4_TOUT22_P33_0_OUT  /* Pin driven by the PWM, P33.0                   */
#define PHASE_V_LS                &IfxGtm_TOM1_3_TOUT21_P00_12_OUT /* Pin driven by the PWM, P00.12                  */
#define PHASE_W_HS                &IfxGtm_TOM1_6_TOUT24_P33_2_OUT  /* Pin driven by the PWM, P33.2                   */
#define PHASE_W_LS                &IfxGtm_TOM1_5_TOUT41_P23_0_OUT  /* Pin driven by the PWM, P23.0                   */

#define GTM_TOM_MASTER            IfxGtm_Tom_1                     /* Define the timer used                          */
#define GTM_TOM_MASTER_TIMER_CH   IfxGtm_Tom_Ch_0                  /* Define the timer channel used                  */

#define DUTY_25_PERCENT           0.25                             /* Define 25% duty cycle                          */
#define DUTY_50_PERCENT           0.50                             /* Define 50% duty cycle                          */
#define DUTY_75_PERCENT           0.75                             /* Define 75% duty cycle                          */
#define DUTY_STEP                 0.1                              /* Define duty cycle step                         */
#define DUTY_MIN                  0.1                              /* Define minimum duty cycle (10%)                */
#define DUTY_MAX                  0.9                              /* Define maximum duty cycle (90%)                */

/*********************************************************************************************************************/
/*-------------------------------------------------Data Structures---------------------------------------------------*/
/*********************************************************************************************************************/
/* Structure for three phase PWM output configuration and handling */
typedef struct
{
    IfxGtm_Tom_Timer    timer;                  /* Timer driver                                                      */
    IfxGtm_Tom_PwmHl    pwm;                    /* GTM TOM PWM driver object                                         */
    Ifx_TimerValue      pwmOnTimes[3];          /* PWM ON-time for 3 phases                                          */
} Pwm3PhaseOutput;

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
Pwm3PhaseOutput g_pwm3PhaseOutput;

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
/* This function initializes the TOM */
void initGtmTomPwm(void)
{
    /* Enable the GTM Module */
    IfxGtm_enable(&MODULE_GTM);
    /* Set the GTM global clock frequency in Hz */
    IfxGtm_Cmu_setGclkFrequency(&MODULE_GTM, IfxGtm_Cmu_getModuleFrequency(&MODULE_GTM));
    /* Set the GTM configurable clock frequency in Hz */
    IfxGtm_Cmu_setClkFrequency(&MODULE_GTM, IfxGtm_Cmu_Clk_0, IfxGtm_Cmu_getGclkFrequency(&MODULE_GTM));
    /* Enable the FXU clock                         */
    IfxGtm_Cmu_enableClocks(&MODULE_GTM, IFXGTM_CMU_CLKEN_FXCLK);

    IfxGtm_Tom_Timer_Config timerConfig;                                         /* Timer configuration              */
    {
        IfxGtm_Tom_Timer_initConfig(&timerConfig, &MODULE_GTM);                  /* Initialize default parameters    */

        timerConfig.base.frequency = PWM_FREQ_HZ;                                /* Set timer frequency              */
        timerConfig.clock= IfxGtm_Tom_Ch_ClkSrc_cmuFxclk0;                       /* Define the CMU clock used        */
        timerConfig.tom = GTM_TOM_MASTER;                                        /* Define the timer used            */
        timerConfig.timerChannel = GTM_TOM_MASTER_TIMER_CH;                      /* Define the channel used          */
        IfxGtm_Tom_Timer_init(&g_pwm3PhaseOutput.timer, &timerConfig);           /* Initialize the TOM               */
    }

    /* Configuration of the PWM channels to control High-side and Low-side power-stages */
    {
        IfxGtm_Tom_PwmHl_Config pwmHlConfig;
        IfxGtm_Tom_ToutMapP ccx[] =
        {
            PHASE_U_HS, /* PWM High-side 1 */
            PHASE_V_HS, /* PWM High-side 2 */
            PHASE_W_HS  /* PWM High-side 3 */
        };
        IfxGtm_Tom_ToutMapP coutx[] =
        {
            PHASE_U_LS, /* PWM Low-side 1 */
            PHASE_V_LS, /* PWM Low-side 2 */
            PHASE_W_LS  /* PWM Low-side 3 */
        };

        /* Initialize the configuration structure to default */
        IfxGtm_Tom_PwmHl_initConfig(&pwmHlConfig);
        /* Calculate the number of PWM channels */
        pwmHlConfig.base.channelCount = sizeof(ccx) / sizeof(IfxGtm_Tom_ToutMapP);
        /* Dead time between the top and bottom channels in seconds */
        pwmHlConfig.base.deadtime = PWM_DEAD_TIME;
        /* Min pulse allowed as active state for the top and bottom PWM in seconds */
        pwmHlConfig.base.minPulse = PWM_MIN_PULSE_TIME;
        /* Set output mode of ccx and coutx pins */
        pwmHlConfig.base.outputMode = IfxPort_OutputMode_pushPull;
        /* Set output pad driver of ccx and coutx pins */
        pwmHlConfig.base.outputDriver = IfxPort_PadDriver_cmosAutomotiveSpeed1;
        /* Set top PWM active state */
        pwmHlConfig.base.ccxActiveState = Ifx_ActiveState_high;
        /* Set bottom PWM active state */
        pwmHlConfig.base.coutxActiveState = Ifx_ActiveState_high;

        pwmHlConfig.ccx   = ccx;                        /* Assign the channels for High-side switches   */
        pwmHlConfig.coutx = coutx;                      /* Assign the channels for Low-side switches    */
        pwmHlConfig.timer = &g_pwm3PhaseOutput.timer;
        pwmHlConfig.tom   = timerConfig.tom;

        /* Initialize timer object */
        IfxGtm_Tom_PwmHl_init(&g_pwm3PhaseOutput.pwm, &pwmHlConfig);
        /* Sets the PWM mode to center aligned */
        IfxGtm_Tom_PwmHl_setMode(&g_pwm3PhaseOutput.pwm, Ifx_Pwm_Mode_centerAligned);
        /* Update the input frequency */
        IfxGtm_Tom_Timer_updateInputFrequency(&g_pwm3PhaseOutput.timer);
    }

    /* Run the timer */
    IfxGtm_Tom_Timer_run(&g_pwm3PhaseOutput.timer);
    /* Calculate initial values of PWM duty cycles */
    g_pwm3PhaseOutput.pwmOnTimes[0] = g_pwm3PhaseOutput.pwm.timer->base.period * DUTY_25_PERCENT;
    g_pwm3PhaseOutput.pwmOnTimes[1] = g_pwm3PhaseOutput.pwm.timer->base.period * DUTY_50_PERCENT;
    g_pwm3PhaseOutput.pwmOnTimes[2] = g_pwm3PhaseOutput.pwm.timer->base.period * DUTY_75_PERCENT;
    /* Update PWM duty cycles */
    IfxGtm_Tom_Timer_disableUpdate(&g_pwm3PhaseOutput.timer);
    IfxGtm_Tom_PwmHl_setOnTime(&g_pwm3PhaseOutput.pwm, g_pwm3PhaseOutput.pwmOnTimes);
    IfxGtm_Tom_Timer_applyUpdate(&g_pwm3PhaseOutput.timer);
}

/* This function sets the duty cycle of the PWM signals */
void updateGtmTomPwmDutyCycles(void)
{
    Ifx_TimerValue period;
    Ifx_TimerValue dutyStep;
    Ifx_TimerValue dutyStepMin;
    Ifx_TimerValue dutyStepMax;

    /* Get timer period */
    period = g_pwm3PhaseOutput.pwm.timer->base.period;
    /* Calculate duty cycle increment */
    dutyStep = period * DUTY_STEP;

    /* Calculate PWM duty cycles limits */
    dutyStepMin = period * DUTY_MIN;
    dutyStepMax = period * DUTY_MAX;

    /* Increment PWM duty cycles */
    g_pwm3PhaseOutput.pwmOnTimes[0] += dutyStep;
    g_pwm3PhaseOutput.pwmOnTimes[1] += dutyStep;
    g_pwm3PhaseOutput.pwmOnTimes[2] += dutyStep;

    /* Limit PWM duty cycles between dutyStepMin and dutyStepMax */
    if(g_pwm3PhaseOutput.pwmOnTimes[0] >= dutyStepMax)
    {
        g_pwm3PhaseOutput.pwmOnTimes[0] = dutyStepMin;
    }
    if(g_pwm3PhaseOutput.pwmOnTimes[1] >= dutyStepMax)
    {
        g_pwm3PhaseOutput.pwmOnTimes[1] = dutyStepMin;
    }
    if(g_pwm3PhaseOutput.pwmOnTimes[2] >= dutyStepMax)
    {
        g_pwm3PhaseOutput.pwmOnTimes[2] = dutyStepMin;
    }

    /* Update new PWM duty cycles */
    IfxGtm_Tom_Timer_disableUpdate(&g_pwm3PhaseOutput.timer);
    IfxGtm_Tom_PwmHl_setOnTime(&g_pwm3PhaseOutput.pwm, g_pwm3PhaseOutput.pwmOnTimes);
    IfxGtm_Tom_Timer_applyUpdate(&g_pwm3PhaseOutput.timer);
}
