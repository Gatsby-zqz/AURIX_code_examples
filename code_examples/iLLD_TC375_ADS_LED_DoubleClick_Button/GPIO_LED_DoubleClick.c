/**********************************************************************************************************************
 * \file GPIO_LED_DoubleClick.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 * 
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of 
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 * 
 * Boost Software License - Version 1.0 - August 17th, 2003
 * 
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and 
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 * 
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all 
 * derivative works of the Software, unless such copies or derivative works are solely in the form of 
 * machine-executable object code generated by a source language processor.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE 
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS 
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "GPIO_LED_DoubleClick.h"
#include "IfxPort.h"
#include "Ifx_Types.h"
#include "IfxGpt12.h"
#include "Bsp.h"

/*********************************************************************************************************************/
/*-----------------------------------------------------Macros--------------------------------------------------------*/
/*********************************************************************************************************************/
#define LED1     &MODULE_P00, 5   /* Port pin for the LED1   */
#define LED2     &MODULE_P00, 6   /* Port pin for the LED2   */
#define BUTTON   &MODULE_P00, 7   /* Port pin for the button */

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
uint8 g_buttonPressNumber        = 0;           /* Number of times the button is pressed in timeout period          */
boolean g_buttonIsAlreadyPressed = FALSE;       /* Flag to detect if the button is already pressed                  */
boolean g_timerStarted           = FALSE;       /* Flag used to check if the timer has been already started         */

Ifx_TickTime g_deadLine          = 0;           /* deadline for the timer                                           */
Ifx_TickTime g_timeout           = 30000000;    /* Timeout for the timer (300 ms) [in ticks], referred to the
                                                 * peripheral clock frequency, set to 100MHz in this example        */

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/
void control_LED (void);

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
/* Function to configure the port pins for the button and LED */
void init_GPIOs (void)
{
    /* Set the port pin connected to the LED to general output mode push-pull.
     * This function can be used to initialize any port pin by specifying
     * the port number, pin number and port pin mode.
     */
    IfxPort_setPinMode(LED1, IfxPort_Mode_outputPushPullGeneral);
    IfxPort_setPinMode(LED2, IfxPort_Mode_outputPushPullGeneral);

    /* Set all the two LEDs off */
    IfxPort_setPinHigh(LED1);
    IfxPort_setPinHigh(LED2);

    /* Set the port pin connected to the push-button to input mode.
     * This function can be used to set any port to input mode by simply by specifying the port number as shown.
     */
    IfxPort_setPinMode(BUTTON, IfxPort_Mode_inputPullUp);
}

/* Function to check if the button is pressed */
void control_button (void)
{
    /* The IfxPort_getPinState() routine can be used to retrieve the value of a specific pin.
     * This function can be used to retrieve the state of the pin simply by the port number, as shown.
     * Pressing the button increments the number. A flag is set to avoid counting when the button is held down.
     */
    if ((IfxPort_getPinState(BUTTON) == 0) && (g_buttonIsAlreadyPressed == FALSE))
    {
        /* Set the flag to notify that the button is pressed */
        g_buttonIsAlreadyPressed = TRUE;

        /* Increase the number of times the button is pressed */
        g_buttonPressNumber++;
    }

    /* When the button is released, the flag is reset and the timer is started */
    else if ((IfxPort_getPinState(BUTTON) == 1) && (g_buttonIsAlreadyPressed == TRUE))
    {
        /* Reset the flag to notify that button is pressed */
        g_buttonIsAlreadyPressed = FALSE;

        /* The timer used to detect the double click event starts at the first press */
        if (g_buttonPressNumber == 1)
        {
            /* Setting the timer start flag */
            g_timerStarted = TRUE;

            /* Setting the timer deadline */
            g_deadLine = getDeadLine(g_timeout);
        }
    }
}

/* Function to control whether the timer used to detect the double click event is started */
void check_timer (void)
{
    /* If the flag is true, the button has been pressed. The function checks if the timer has expired and calls the
     * function that controls the LEDs
     */
    if (g_timerStarted == TRUE)
    {
        /* When the deadline is reached, call the function to control the LEDs. */
        if (isDeadLine(g_deadLine) == TRUE)
        {
            control_LED();

            /* Reset the flag */
            g_timerStarted = FALSE;
        }
    }
}

/* Function to check if the button is pressed once or twice and toggle the state of the LEDs */
void control_LED (void)
{
    if (g_buttonPressNumber == 1)
    {
        /* The routine IfxPort_togglePin() is used to change the status of a specific pin
         * The button has been pressed once. This changes the state of LED1.
         */
        IfxPort_togglePin(LED1);
    }
    else
    {
        /* The button has been pressed twice. This changes the state of LED2 */
        IfxPort_togglePin(LED2);
    }

    /* Reset the counter */
    g_buttonPressNumber = 0;
}
