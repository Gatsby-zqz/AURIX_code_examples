/**********************************************************************************************************************
 * \file Httpd_SSI_CGI.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/



#include <stdio.h>
#include "lwip/def.h"
#include "lwip/api.h"
#include "lwip/tcpip.h"
#include "lwip/init.h"
#include "lwip/sys.h"
#include "lwip/apps/httpd.h"
#include <string.h>
#include "Ifx_Types.h"
#include "Ifx_reg.h"
#include "IfxPort.h"
#include "IfxPort_PinMap.h"
#include "Die_Temp_Sensor.h"

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/

const char *ledcontrol_handler(int iIndex, int iNumParams, char *pcParam[], char *pcValue[]);
const char *data_handler(int iIndex, int iNumParams, char *pcParam[], char *pcValue[]);

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/

/* text based tag, value pairs to be exchanged over SSI */
static const char *g_ssi_tags[] =
{
  "cpu_temp",
};

/* LWIP structure to set-up function pointers for CGI requests */
tCGI led_handler_struct[] =
{
    {
        .pcCGIName = "/ledcontrol.cgi",               /* LED1 Control */
        .pfnCGIHandler = ledcontrol_handler
    },
    {
        .pcCGIName = "/data.cgi",                     /* CPU Temperature (reply sent via SSI) */
        .pfnCGIHandler = data_handler
    }
};

uint16 g_cpu_temperature = 20;                        /* CPU Die Temperature */

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/

/* Function to convert decimal number to string, converts CPU temperature to a string for transmission */
int int_to_str(char* string_p, int number_i)
{
    int l_divide_i;
    int l_modResult_i;
    int l_length_i;
    int l_isNegative_i;
    int l_copyOfNumber_i;

    if (string_p == NULL)
    {
        return 0;
    }

    if (number_i == 0)
    {
       string_p[0] = '0';
       string_p[1] = '\0';
       return 1;
    }

    l_divide_i = 0;
    l_length_i = 0;
    l_isNegative_i = 0;
    l_copyOfNumber_i = number_i;

    if (number_i < 0)
    {
        l_isNegative_i = 1;
        number_i = -number_i;
        l_length_i++;
    }

    while (l_copyOfNumber_i != 0)
    {
        l_length_i++;
        l_copyOfNumber_i /= 10;
    }

    for (l_divide_i = 0; l_divide_i < l_length_i; l_divide_i++)
    {
        l_modResult_i = number_i % 10;
        number_i    = number_i / 10;
        string_p[l_length_i - (l_divide_i + 1)] = l_modResult_i + '0';
    }

    if (l_isNegative_i == 1)
    {
        string_p[0] = '-';
    }
    string_p[l_length_i] = '\0';

    return (l_length_i);
}

/* CGI Handler to control LED1 */
const char *ledcontrol_handler(int iIndex, int iNumParams, char *pcParam[], char *pcValue[])
{
    (void)iIndex;
    (void)iNumParams;
    (void)pcParam;

    if (strcmp(pcValue[0], "led0") == 0)
    {
        IfxPort_setPinLow(IfxPort_P00_5.port, IfxPort_P00_5.pinIndex);
    }
    else if (strcmp(pcValue[0], "led1") == 0)
    {
        IfxPort_setPinHigh(IfxPort_P00_5.port, IfxPort_P00_5.pinIndex);
    }

    return "/cgi.htm";
}

/* CGI Handler for any other generic CGI request i.e. CPU temperature */
const char *data_handler(int iIndex, int iNumParams, char *pcParam[], char *pcValue[])
{
    (void)iIndex;
    (void)iNumParams;
    (void)pcParam;
    (void)pcValue;

    return "/data.ssi";
}

/* Function to initialize the CGI interface */
int cgi_init(void)
{
    http_set_cgi_handlers(led_handler_struct, 2);

    IfxPort_setPinModeOutput(IfxPort_P00_5.port, IfxPort_P00_5.pinIndex, IfxPort_OutputMode_pushPull, IfxPort_OutputIdx_general);
    IfxPort_setPinHigh(IfxPort_P00_5.port, IfxPort_P00_5.pinIndex);
    return 0;
}

/* SSI handler to prepare CPU temperature as a SSI response to a CGI request from the web browser */
static uint16_t ssi_handler(int iIndex, char *pcInsert, int iInsertLen)
{
    (void)iIndex;
    (void)iInsertLen;
    uint16 n;

    n = (uint16)int_to_str(pcInsert, g_cpu_temperature);

    return (n);
}

/* Function to initialize the SSI interface */
void ssi_init(void)
{
    for (size_t i = 0; i < LWIP_ARRAYSIZE(g_ssi_tags); ++i)
    {
        LWIP_ASSERT("tag too long for LWIP_HTTPD_MAX_TAG_NAME_LEN",
        strlen(g_ssi_tags[i]) <= LWIP_HTTPD_MAX_TAG_NAME_LEN);
    }

    http_set_ssi_handler(ssi_handler, g_ssi_tags, LWIP_ARRAYSIZE(g_ssi_tags));
}
